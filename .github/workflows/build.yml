name: Build GKI A12-5.10

permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:
    inputs:
      tag_selection:
        description: "选择内核版本 (格式: 子版本 | 补丁日期 | 修订号)"
        required: true
        type: choice
        options:
          - "5.10.246 | 2025-12 | r1"
          - "5.10.240 | 2025-09 | r2"
          - "5.10.233 | 2025-02 | r5"
          - "5.10.226 | 2024-11 | r8"
          - "5.10.218 | 2024-08 | r14"
          - "5.10.209 | 2024-05 | r13"
          - "Manual Input (See below)"
        default: "5.10.233 | 2025-02 | r5"
      
      manual_version:
        description: "手动版本参数 (仅 Manual 模式生效, 格式: 5.10.233 2025-02 r5)"
        required: false
        type: string
      
      version:
        description: '自定义版本名 (如 -MyKernel)'
        required: false
        type: string
      
      build_time:
        description: '设置内核构建时间 (留空使用当前时间)'
        required: false
        type: string

      kernelsu_variant:
        description: "选择 KernelSU 变体"
        required: true
        type: choice
        options:
          - ReSukiSU
          - SukiSU
          - Official
          - MKSU
        default: ReSukiSU
      kernelsu_branch:
        description: "选择 ksu 分支"
        required: true
        type: choice
        options:
          - Stable(标准)
          - Dev(开发)
          - tmp-builtin
        default: Stable(标准)
      use_zram:
        description: '开启更多zram算法?'
        required: true
        type: boolean
        default: true
      use_bbg:
        description: '开启 BBG 防格机?'
        required: true
        type: boolean
        default: true
      use_kpm:
        description: '开启 KPM?'
        required: true
        type: boolean
        default: true
      enable_tmpfs:
        description: '启用tmpfs?'
        required: true
        type: boolean
        default: true
      bypass_unicode:
        description: '启用零宽空格修复?'
        required: true
        type: boolean
        default: true
      cancel_susfs:
        description: '取消 SUSFS'
        required: true
        type: boolean
        default: false
      onlyAk3:
        description: '仅上传 AK3 (不打包 boot.img)?'
        required: false
        type: boolean
        default: false

jobs:
  build-kernel:
    runs-on: ubuntu-latest
    env:
      ANDROID_VERSION: "android12"
      KERNEL_VERSION: "5.10"
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"

    steps:
      - name: Maximize Build Space
        uses: AdityaGarg8/remove-unwanted-software@v5
        with:
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          verbose: 'false'

      - name: Checkout repository
        uses: actions/checkout@v4

      # ========================================================
      # 解析版本参数
      # ========================================================
      - name: 解析版本参数
        run: |
          SELECTION="${{ inputs.tag_selection }}"
          MANUAL="${{ inputs.manual_version }}"
          
          if [[ "$SELECTION" == "Manual Input"* ]] && [[ -n "$MANUAL" ]]; then
            echo "使用手动输入的版本: $MANUAL"
            SUB_LEVEL=$(echo "$MANUAL" | awk '{print $1}' | cut -d. -f3)
            OS_PATCH=$(echo "$MANUAL" | awk '{print $2}')
            REV=$(echo "$MANUAL" | awk '{print $3}')
          else
            echo "使用预设版本: $SELECTION"
            SUB_LEVEL=$(echo "$SELECTION" | awk -F' | ' '{print $1}' | cut -d. -f3)
            OS_PATCH=$(echo "$SELECTION" | cut -d'|' -f2 | xargs)
            REV=$(echo "$SELECTION" | cut -d'|' -f3 | xargs)
          fi

          echo "解析结果: 5.10.$SUB_LEVEL / $OS_PATCH / $REV"
          echo "SUB_LEVEL=$SUB_LEVEL" >> $GITHUB_ENV
          echo "OS_PATCH_LEVEL=$OS_PATCH" >> $GITHUB_ENV
          echo "REVISION=$REV" >> $GITHUB_ENV
          echo "CONFIG=android12-5.10-$SUB_LEVEL" >> $GITHUB_ENV

      - name: 安装构建依赖
        run: sudo apt update && sudo apt install -y ccache python3 git curl build-essential libssl-dev bison flex libelf-dev dwarves

      - name: 下载工具链
        run: |
          mkdir -p ./git-repo
          curl https://storage.googleapis.com/git-repo-downloads/repo > ./git-repo/repo
          chmod a+rx ./git-repo/repo
          echo "REPO=$GITHUB_WORKSPACE/git-repo/repo" >> $GITHUB_ENV
          
          AOSP_MIRROR=https://android.googlesource.com
          BRANCH=main-kernel-build-2024
          git clone $AOSP_MIRROR/kernel/prebuilts/build-tools -b $BRANCH --depth 1 kernel-build-tools
          git clone $AOSP_MIRROR/platform/system/tools/mkbootimg -b $BRANCH --depth 1 mkbootimg
          
          echo "MKBOOTIMG=$GITHUB_WORKSPACE/mkbootimg/mkbootimg.py" >> $GITHUB_ENV
          echo "UNPACK_BOOTIMG=$GITHUB_WORKSPACE/mkbootimg/unpack_bootimg.py" >> $GITHUB_ENV
          echo "AVBTOOL=$GITHUB_WORKSPACE/kernel-build-tools/linux-x86/bin/avbtool" >> $GITHUB_ENV
          
          openssl genpkey -algorithm RSA -pkeyopt rsa_keygen_bits:2048 > ./kernel-build-tools/linux-x86/share/avb/testkey_rsa2048.pem
          echo "BOOT_SIGN_KEY_PATH=$GITHUB_WORKSPACE/kernel-build-tools/linux-x86/share/avb/testkey_rsa2048.pem" >> $GITHUB_ENV

      - name: 克隆patch仓库
        run: |
          git clone https://github.com/WildPlusKernel/AnyKernel3.git -b "gki-2.0"
          git clone https://github.com/ShirkNeko/SukiSU_patch.git
          git clone https://github.com/zzh20188/GKI_KernelSU_SUSFS.git zzh_patch
          git clone https://github.com/Numbersf/Action-Build.git --depth=1
          git clone https://github.com/Xiaomichael/kernel_patches.git xiaoxiaow_patch
          
          if [ "${{ inputs.kernelsu_variant }}" == "SukiSU" ] || [ "${{ inputs.kernelsu_variant }}" == "ReSukiSU" ]; then
            git clone https://github.com/ShirkNeko/susfs4ksu.git -b "gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}"
          else
            git clone https://gitlab.com/simonpunk/susfs4ksu.git -b "gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}"
          fi

      - name: 同步内核源码
        run: |
          mkdir -p "$CONFIG"
          cd "$CONFIG"
          git clone https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_aarch64_aarch64-linux-gnu-6.4.1.git gcc

          MANIFEST_BRANCH="common-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}-${{ env.OS_PATCH_LEVEL }}"
          echo "正在同步分支: $MANIFEST_BRANCH"
          
          $REPO init --depth=1 -u https://android.googlesource.com/kernel/manifest -b $MANIFEST_BRANCH --repo-rev=v2.16
          
          if ! $REPO sync -c -j$(nproc --all) --fail-fast; then
             echo "错误: 无法同步分支 $MANIFEST_BRANCH，尝试通用分支..."
             $REPO init --depth=1 -u https://android.googlesource.com/kernel/manifest -b common-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}
             $REPO sync -c -j$(nproc --all) --fail-fast
          fi

      - name: 确定 KernelSU 参数
        run: |
          VAR="${{ inputs.kernelsu_variant }}"
          BR="${{ inputs.kernelsu_branch }}"
          ARG=""
          if [ "$BR" == "tmp-builtin" ]; then
             ARG="-s tmp-builtin"
          elif [ "$BR" == "Stable(标准)" ]; then
             if [[ "$VAR" == "SukiSU" || "$VAR" == "ReSukiSU" ]]; then ARG="-s builtin"; else ARG="-s stable"; fi
          elif [ "$BR" == "Dev(开发)" ]; then
             if [[ "$VAR" == "SukiSU" || "$VAR" == "ReSukiSU" ]]; then ARG="-s tmp-builtin"; else ARG="-s main"; fi
          fi
          echo "KSU_ARGS=$ARG" >> $GITHUB_ENV

      - name: 注入 KernelSU
        run: |
          cd "$CONFIG"
          case "${{ inputs.kernelsu_variant }}" in
            "Official") URL="https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" ;;
            "ReSukiSU") URL="https://raw.githubusercontent.com/ReSukiSU/ReSukiSU/main/kernel/setup.sh" ;;
            "MKSU")     URL="https://raw.githubusercontent.com/5ec1cff/KernelSU/main/kernel/setup.sh" ;;
            "SukiSU")   URL="https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" ;;
          esac
          curl -LSs "$URL" | bash -s ${{ env.KSU_ARGS }}

      - name: 注入 SUSFS
        if: ${{ !inputs.cancel_susfs }}
        run: |
          set -e
          cd "$CONFIG"
          cp ../susfs4ksu/kernel_patches/50_add_susfs_in_gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch ./common/
          cp ../susfs4ksu/kernel_patches/fs/* ./common/fs/
          cp ../susfs4ksu/kernel_patches/include/linux/* ./common/include/linux/

          #KSU_DIR=$(find . -maxdepth 1 -type d -name "KernelSU*" | head -n 1)
          #if [ -n "$KSU_DIR" ]; then
          #  cd "$KSU_DIR"
          #  cp ../../susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch ./
          #  patch -p1 --fuzz=3 --forward < 10_enable_susfs_for_ksu.patch || echo "KSU Patch warning"
          #  cd ..
          #fi
          cd common
          patch -p1 --fuzz=3 < 50_add_susfs_in_gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch

      # ========================================================
      # [核心修复] 注入 ZRAM/BBG 补丁 (补全了复制源代码的命令)
      # ========================================================
      - name: 注入 ZRAM/BBG 补丁
        run: |
          cd "$CONFIG/common"
          patch -p1 --forward < "../../Action-Build/patches/optimized_mem_operations.patch"
          patch -p1 --forward < "../../Action-Build/patches/file_struct_8bytes_align.patch"
          
          if [ "${{ inputs.use_zram }}" == "true" ]; then
            echo "Processing ZRAM/LZ4K..."
            # 1. [修复] 复制 LZ4K 和 OPlus 源代码
            # 这些文件对于 lz4kd.patch 生效是必须的
            cp -r ../../SukiSU_patch/other/zram/lz4k/include/linux/* ./include/linux/
            cp -r ../../SukiSU_patch/other/zram/lz4k/lib/* ./lib/
            cp -r ../../SukiSU_patch/other/zram/lz4k/crypto/* ./crypto/
            cp -r ../../SukiSU_patch/other/zram/lz4k_oplus ./lib/

            # 2. 应用 LZ4 1.10.0 (From zzh_patch)
            rm -f lib/lz4/*
            cp -r ../../zzh_patch/zram/lz4/* ./lib/lz4/
            cp -r ../../zzh_patch/zram/include/linux/* ./include/linux/
            cp ../../zzh_patch/zram/${{ env.KERNEL_VERSION }}/lz4_1.10.0.patch ./
            patch -p1 -F 3 --fuzz=5 < lz4_1.10.0.patch || true
            
            # 3. 应用 LZ4KD & OPlus patches
            cp ../../SukiSU_patch/other/zram/zram_patch/${{ env.KERNEL_VERSION }}/lz4kd.patch ./
            patch -p1 -F 3 < lz4kd.patch || true
            
            cp ../../SukiSU_patch/other/zram/zram_patch/${{ env.KERNEL_VERSION }}/lz4k_oplus.patch ./
            patch -p1 -F 3 < lz4k_oplus.patch || true
          fi
          
          if [ "${{ inputs.use_bbg }}" == "true" ]; then
            cd ..
            wget -O- https://github.com/vc-teahouse/Baseband-guard/raw/main/setup.sh | bash
            sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/lockdown/lockdown,baseband_guard/ } }' common/security/Kconfig
          fi

      - name: 绕过零宽空格检测
        run: |
          cd "$CONFIG/common"
          if [ "${{ inputs.bypass_unicode }}" == "true" ]; then
          cp ../../xiaoxiaow_patch/common/unicode_bypass_fix_6.1-.patch ./
          patch -p1 -F 3 --fuzz=5 < unicode_bypass_fix_6.1-.patch || true
          fi

      - name: 配置 Defconfig
        run: |
          cd "$CONFIG"
          DEFCONFIG="common/arch/arm64/configs/gki_defconfig"
          echo "CONFIG_KSU=y" >> $DEFCONFIG
          echo "CONFIG_WERROR=n" >> $DEFCONFIG
          if [[ "${{ inputs.kernelsu_variant }}" == *"SukiSU"* ]] && [[ "${{ inputs.use_kpm }}" == "true" ]]; then
             echo "CONFIG_KPM=y" >> $DEFCONFIG
          fi
          if [ "${{ inputs.use_zram }}" == "true" ]; then
             echo "CONFIG_ZSMALLOC=y" >> $DEFCONFIG
             echo "CONFIG_ZRAM=y" >> $DEFCONFIG
             echo "CONFIG_ZRAM_DEF_COMP_LZ4KD=y" >> $DEFCONFIG
             echo "CONFIG_CRYPTO_LZ4K=y" >> $DEFCONFIG
             echo "CONFIG_CRYPTO_LZ4K_OPLUS=y" >> $DEFCONFIG
             echo "CONFIG_CRYPTO_842=y" >> $DEFCONFIG
             echo "CONFIG_MODULE_SIG=n" >> $DEFCONFIG
             echo "CONFIG_CRYPTO_LZO=y" >> $DEFCONFIG
             echo "CONFIG_CRYPTO_LZ4HC=y" >> $DEFCONFIG
             echo "CONFIG_CRYPTO_LZ4KD=y" >> $DEFCONFIG
          fi
          if [ "${{ inputs.use_bbg }}" == "true" ]; then echo "CONFIG_BBG=y" >> $DEFCONFIG; fi
          if [ "${{ inputs.enable_tmpfs }}" == "true" ]; then 
             echo "CONFIG_TMPFS_XATTR=y" >> $DEFCONFIG
             echo "CONFIG_TMPFS_POSIX_ACL=y" >> $DEFCONFIG
          fi
          if [ "${{ inputs.cancel_susfs }}" == "false" ]; then
             echo "CONFIG_KSU_SUSFS=y" >> $DEFCONFIG
             echo "CONFIG_KSU_SUSFS_SUS_PATH=y" >> $DEFCONFIG
             echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y" >> $DEFCONFIG
             echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y" >> $DEFCONFIG
             echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y" >> $DEFCONFIG
             echo "CONFIG_KSU_SUSFS_SUS_KSTAT=y" >> $DEFCONFIG
             echo "CONFIG_KSU_SUSFS_TRY_UMOUNT=y" >> $DEFCONFIG
             echo "CONFIG_KSU_SUSFS_SPOOF_UNAME=y" >> $DEFCONFIG
             echo "CONFIG_KSU_SUSFS_ENABLE_LOG=y" >> $DEFCONFIG
             echo "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y" >> $DEFCONFIG
             echo "CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y" >> $DEFCONFIG
             echo "CONFIG_KSU_SUSFS_OPEN_REDIRECT=y" >> $DEFCONFIG
             echo "CONFIG_KSU_SUSFS_SUS_MAP=y" >> $DEFCONFIG
          fi
          sed -i 's/check_defconfig//g' common/build.config.gki*

      - name: 设置构建时间与版本
        run: |
          cd "$CONFIG"
          if [ -n "${{ inputs.build_time }}" ]; then
             echo "正在设置构建时间: ${{ inputs.build_time }}"
             perl -pi -e "s{UTS_VERSION=\"\\\$\(echo \\\$UTS_VERSION \\\$CONFIG_FLAGS \\\$TIMESTAMP \\| cut -b -\\\$UTS_LEN\)\"}{UTS_VERSION=\"#1 SMP PREEMPT ${{ inputs.build_time }}\"}" ./common/scripts/mkcompile_h
          fi
          
          if [ -n "${{ inputs.version }}" ]; then
             echo "正在设置版本后缀: ${{ inputs.version }}"
             sed -i '$s|echo "\$res"|echo "${{ inputs.version }}"|' ./common/scripts/setlocalversion
             sed -i '/^CONFIG_LOCALVERSION=/ s/="\([^"]*\)"/="${{ inputs.version }}"/' common/arch/arm64/configs/gki_defconfig
          fi

      - name: 编译内核
        run: |
          cd "$CONFIG"
          sed -i 's/BUILD_SYSTEM_DLKM=1/BUILD_SYSTEM_DLKM=0/' ./common/build.config.gki.aarch64
          sed -i '/MODULES_ORDER=android\/gki_aarch64_modules/d' ./common/build.config.gki.aarch64
          sed -i '/KMI_SYMBOL_LIST_STRICT_MODE/d' ./common/build.config.gki.aarch64
          
          echo "开始编译..."
          LTO=thin BUILD_CONFIG=common/build.config.gki.aarch64 build/build.sh CC="/usr/bin/ccache clang"

      - name: KPM Patch & AnyKernel3
        run: |
           if [[ "${{ inputs.use_kpm }}" == "true" ]] && [[ "${{ inputs.kernelsu_variant }}" == *"SukiSU"* ]]; then
             cd "$CONFIG/out/${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}/dist"
             curl -LSs "https://github.com/SukiSU-Ultra/SukiSU_KernelPatch_patch/releases/download/0.12.2/patch_linux" -o patch
             chmod 777 patch
             ./patch
             rm -rf Image && mv oImage Image
             cd ../../../..
           fi
           
           cd AnyKernel3
           cp ../$CONFIG/out/${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}/dist/Image ./
           ZIP_NAME="GKI-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.${{ env.SUB_LEVEL }}-${{ env.OS_PATCH_LEVEL }}-${{ inputs.kernelsu_variant }}.zip"
           zip -r "$ZIP_NAME" ./*
           echo "ZIP_PATH=$GITHUB_WORKSPACE/AnyKernel3/$ZIP_NAME" >> $GITHUB_ENV

      - name: 编译 Boot.img
        if: ${{ inputs.onlyAk3 == false }}
        run: |
          cd "$CONFIG/out/${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}/dist"
          mkdir bootimgs && cd bootimgs
          cp ../Image ./
          
          GKI_URL="https://dl.google.com/android/gki/gki-certified-boot-android12-5.10-${{ env.OS_PATCH_LEVEL }}_${{ env.REVISION }}.zip"
          
          echo "下载官方 Boot: $GKI_URL"
          if curl --output /dev/null --silent --head --fail "$GKI_URL"; then
             curl -Lo gki.zip "$GKI_URL"
          else
             echo "错误: Google服务器上找不到该版本的 Boot 镜像，尝试使用 Fallback (2023-01)..."
             curl -Lo gki.zip "https://dl.google.com/android/gki/gki-certified-boot-android12-5.10-2023-01_r1.zip"
          fi
          
          unzip gki.zip && rm gki.zip
          $UNPACK_BOOTIMG --boot_img=boot-5.10.img
          
          gzip -n -k -f -9 ./Image > ./Image.gz
          
          $MKBOOTIMG --header_version 4 --kernel Image.gz --output boot-new.img --ramdisk out/ramdisk --os_version 12.0.0 --os_patch_level "${{ env.OS_PATCH_LEVEL }}"
          $AVBTOOL add_hash_footer --partition_name boot --partition_size $((64 * 1024 * 1024)) --image boot-new.img --algorithm SHA256_RSA2048 --key $BOOT_SIGN_KEY_PATH
          
          mv boot-new.img $GITHUB_WORKSPACE/boot.img

      - name: 上传产物
        uses: actions/upload-artifact@v4
        with:
          name: Kernel_Build_Output
          path: |
            ${{ env.ZIP_PATH }}
            *.img

      - name: 保存 Release 元数据
        run: |
          mkdir -p release_info
          
          # 生成 Tag 名字
          echo "v${{ env.KERNEL_VERSION }}.${{ env.SUB_LEVEL }}-${{ env.OS_PATCH_LEVEL }}_${{ github.run_number }}" > release_info/tag_name.txt
          
          # 生成 Release 标题
          echo "Android 12 GKI ${{ env.KERNEL_VERSION }}.${{ env.SUB_LEVEL }} (${{ env.OS_PATCH_LEVEL }})" > release_info/release_title.txt
          
          # 生成 Release 说明正文
          cat <<EOF > release_info/release_body.md
          ### GKI Kernel Build Info
          - **Kernel Version:** 5.10.${{ env.SUB_LEVEL }}
          - **Android Security Patch:** ${{ env.OS_PATCH_LEVEL }}
          - **Revision:** ${{ env.REVISION }}
          - **KernelSU Variant:** ${{ inputs.kernelsu_variant }}
          - **KSU Branch:** ${{ inputs.kernelsu_branch }}
          - **SUSFS:** ${{ inputs.cancel_susfs == 'false' && 'Enabled' || 'Disabled' }}
          - **ZRAM (LZ4):** ${{ inputs.use_zram }}
          - **KPM:** ${{ inputs.use_kpm }}
          - **TMPFS:** ${{ inputs.enable_tmpfs }}
          - **UNICODE　BYPASS:** ${{ bypass_unicode }}
          
          _Built by Github Actions (Run #${{ github.run_number }})_
          EOF

      - name: 上传元数据
        uses: actions/upload-artifact@v4
        with:
          name: release_metadata
          path: release_info/
